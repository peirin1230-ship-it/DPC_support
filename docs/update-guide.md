# DPC検索ツール — データ更新手順書

> **対象**: DPC電子点数表（令和6年度 → 令和8年度等）の改定時にデータを更新する手順
> **前提**: Node.js v18以上がインストール済み、リポジトリをgit cloneしていること
> **所要時間目安**: データ変換スクリプト作成含めて 1〜2日

---

## 目次

1. [更新が必要になるタイミング](#1-更新が必要になるタイミング)
2. [システム構成の全体像](#2-システム構成の全体像)
3. [データ構造リファレンス](#3-データ構造リファレンス)
4. [更新手順](#4-更新手順)
5. [検証手順](#5-検証手順)
6. [デプロイ手順](#6-デプロイ手順)
7. [トラブルシューティング](#7-トラブルシューティング)
8. [チェックリスト](#8-チェックリスト)

---

## 1. 更新が必要になるタイミング

| タイミング | 頻度 | 影響範囲 |
|-----------|------|---------|
| **DPC電子点数表の改定** | 2年に1回 | 全データ（D.dpc, D.cls 等すべて） |
| **DPC点数の経過措置終了** | 改定翌年 | D.dpc の点数のみ |
| **ICD-10の改訂** | 不定期 | D.icd, D.icn, D.sd |
| **出来高算定手術の追加・変更** | 随時 | D.dk |
| **軽微な訂正通知** | 随時 | 該当箇所のみ |


---

## 2. システム構成の全体像

```
厚生労働省 DPC電子点数表（Excel 1ファイル, 18シート）
         │   例: 001660588.xlsx（ファイル名は改定ごとに変わる）
         │
         ▼
  ┌─────────────────┐
  │ 変換スクリプト    │  ← scripts/generate-data.mjs
  │ (Node.js + xlsx) │     database/ 内のExcelをシート名で自動検出
  └────────┬──────────┘
           ▼
    src/data.js          ← 985KB, 1行のminified JavaScript
         │
         ▼
    src/utils.js         ← 検索・計算ロジック（通常変更不要）
         │
         ▼
    src/components/*.jsx ← UI（通常変更不要）
         │
         ▼
    _verify.mjs          ← 検証テスト（542テスト）
         │
         ▼
    npx vite build       ← dist/index.html（単一HTML, 約920KB）
```

**重要**: 通常の点数表更新では `src/data.js` のみ を差し替えます。
`src/utils.js` や UI コンポーネントの変更は、DPC制度の構造的変更がない限り不要です。

---

## 3. データ構造リファレンス

`src/data.js` は `export const D = { ... }` として以下16個のキーを持つオブジェクトをエクスポートします。

### 3.1 DPCコード定義 — `D.dpc`（3,248件）

最も重要なテーブル。DPCコード14桁をキーとし、13要素の配列を値に持ちます。

```javascript
D.dpc["010010xx97x00x"] = [
  "01",     // [0] MDC（主要診断群, 2桁）
  "0010",   // [1] 分類番号（cls, 4桁）
  "1",      // [2] 出来高フラグ（"0"=出来高, "1"=DPC対象）
  "97",     // [3] 手術区分（surgVal）  ※下記参照
  "0",      // [4] 手術・処置等1（p1Val, 相関値）
  "0",      // [5] 手術・処置等2（p2Val, 相関値）
  "0",      // [6] 副傷病（sdVal）
  7,        // [7] 期間Ⅰ日数上限
  14,       // [8] 期間Ⅱ日数上限
  60,       // [9] 期間Ⅲ日数上限（＝DPC算定上限日数）
  3149,     // [10] 期間Ⅰ 点/日
  2164,     // [11] 期間Ⅱ 点/日
  1839      // [12] 期間Ⅲ 点/日
]
```

**DPCコード14桁の構造:**
```
  01  0010  xx  97  x  0  0x
  ──  ────  ──  ──  ─  ─  ──
  MDC  cls  条件 手術 p1 p2 sd
```

**手術区分（surgVal）の意味:**
- `"01"`〜`"07"`: 定義手術（ツリー図上の手術区分番号）
- `"97"`: その他の手術あり（定義テーブルにない手術）
- `"99"`: 手術なし

**相関値（corrVal）について:**
- `"0"`: 該当なし（分岐なしの場合）
- `"1"`, `"2"`, `"3"`, ...: 大きい数値 = ツリー図で下 = **高優先度**
- DPCコーディングの「下から優先」ルールはこの数値で管理される

### 3.2 分類名 — `D.cls`（506件）

```javascript
D.cls["050050"] = "狭心症、慢性虚血性心疾患"
```

### 3.3 ラベル辞書 — `D.lb`（506件）

各分類の手術・処置等の日本語ラベル。

```javascript
D.lb["050050"] = {
  "o": { "02": "経皮的冠動脈形成術等", "97": "あり", "99": "なし" },
  "1": { "1": "あり（中心静脈注射等）" },
  "2": { "1": "あり（SPECT等）", "2": "あり（人工腎臓等）" },
  "s": { "1": "あり" }
}
```

| type | 意味 |
|------|------|
| `"o"` | 手術 |
| `"1"` | 手術・処置等1 |
| `"2"` | 手術・処置等2 |
| `"s"` | 定義副傷病 |
| `"v"` | その他分岐（重症度等） |

### 3.4 分岐定義 — `D.br`（506件）

各分類・手術区分で、処置等1/2/副傷病の分岐が存在するかを記録。

```javascript
D.br["050050"] = {
  "99": { "1": 1, "2": 1, "s": 1 }  // 手術なし(99)の場合: p1分岐あり, p2分岐あり, sd分岐あり
}
```

### 3.5 処置等1定義 — `D.p1`（273件）

```javascript
D.p1["050050"] = {
  "1": ["D2061", "DD01"],      // corrVal=1: これらのコードが該当
  "2": ["D2062", "D2063"]      // corrVal=2: より高優先度
}
```

### 3.6 処置等2定義 — `D.p2`（408件）

```javascript
D.p2["050050"] = {
  "1": ["G005", "J0451"],      // corrVal=1
  "2": ["J0384"],              // corrVal=2
  "3": ["0022", "0008"]        // corrVal=3（最高優先度）
}
```

### 3.7 手術インデックス — `D.si`（506件）+ `D.sl`（594件）

```javascript
D.si["050050"] = { "02": 123, "97": 5, "99": 0 }  // surgVal → D.slのインデックス
D.sl[123] = ["K546", "K5461", "K5462"]             // Kコード配列
D.sl[0]   = ["KKK0"]                                // "手術なし" の特殊コード
```

### 3.8 コード名称辞書 — `D.cn`（2,323件）

```javascript
D.cn["K546"]  = "経皮的冠動脈形成術"
D.cn["G005"]  = "中心静脈注射"
D.cn["KKK0"]  = "手術なし"
D.cn["KKK1"]  = "定義テーブルにない手術"
```

### 3.9 ICD-10関連 — `D.icd`（506件）+ `D.icn`（5,898件）

```javascript
D.icd["050050"] = ["I200", "I201", "I208", "I209", "I251"]  // 分類→ICD配列
D.icn["I200"]   = "不安定狭心症"                               // ICD→病名
```

### 3.10 副傷病定義 — `D.sd`（118件）

```javascript
D.sd["100020"] = {
  "1": ["G50$", "G52$", "C400", "C401"]  // "$" 末尾 = 前方一致（prefix match）
}
```

**注意**: `"$"` で終わるコードは前方一致を意味し、`G50$` は G500, G501, G502... すべてに該当します。

### 3.11 重症度分岐 — `D.sv`（107件）

```javascript
D.sv["100040"] = {
  "name": "ＪＣＳ",
  "0": "JCS0以上10未満",
  "1": "JCS10以上"
}
```

### 3.12 出来高算定手術 — `D.dk`（79件）

```javascript
D.dk["K014"] = "皮膚移植術（生体・培養）"  // このKコードは出来高算定
```

### 3.13 薬剤別名 — `D.da`（280件）

```javascript
D.da["0204"] = ["キイトルーダ"]  // 処置コード→商品名
```

### 3.14 病態等分類 — `D.pt`（6件）

```javascript
D.pt["130110"] = { "x0": "16歳以上", "x1": "16歳未満" }
```

DPCコードの7-8桁目に対応する条件ラベル。

### 3.15 Excelシート → Dキー 変換マッピング

変換スクリプト（`scripts/generate-data.mjs`）がExcelの各シート・列をどのDキーに変換するかの詳細です。

#### 2）分類名称 → D.cls

| Excel列 | 内容 | 変換先 |
|---------|------|--------|
| A列 | MDC（主要診断群, 2桁） | D.cls キーの先頭2桁 |
| B列 | 分類番号（4桁） | D.cls キーの後半4桁 |
| C列 | 分類名称 | D.cls の値 |

```
Excel: [01, 0010, "脳腫瘍"] → D.cls["010010"] = "脳腫瘍"
```

#### 3）病態等分類 + 5）年齢 → D.pt

D.pt は2つのシートと変換テーブルから複合的に生成されます。

| ソース | 用途 |
|--------|------|
| 5）年齢シート | 条件名="年齢"のクラスを抽出、年齢範囲ラベルを生成 |
| 3）病態等分類シート | condCode（DPCコード7桁目）と区分名を抽出 |
| 12）変換テーブル | DPCコード7-8桁目の実在バリエーションを収集 |

**生成条件**: 年齢シートに条件名="年齢"があり、かつ変換テーブルのDPCコード7-8桁目が"xx"以外のバリエーションを持つクラスのみ生成されます。JCS・出生時体重・Burn Indexなどの条件はD.ptの対象外です。

#### 4）ＩＣＤ → D.icd, D.icn

| Excel列 | 内容 | 変換先 |
|---------|------|--------|
| A列 | MDC | D.icd キーの先頭2桁 |
| B列 | 分類番号 | D.icd キーの後半4桁 |
| C列 | ICD-10名称 | D.icn の値 |
| D列 | ICD-10コード | D.icd の配列要素, D.icn のキー |

> **注意**: `"$"` 末尾のコード（例: `"C71$"`）は前方一致を意味し、Excelの原データにそのまま含まれています。

#### 6）手術 → D.si, D.sl, D.cn

| Excel列 | 内容 | 変換先 |
|---------|------|--------|
| A列 | MDC | D.si キーの先頭2桁 |
| B列 | 分類番号 | D.si キーの後半4桁 |
| F列 | 手術区分（surgVal, 2桁） | D.si[cls] のサブキー |
| G〜P列 | Kコード名称 + Kコード（ペアで交互） | D.sl の配列内容, D.cn |

**D.si/D.sl の間接参照構造**: 同一のKコード配列を持つ手術区分はD.slのインデックスを共有し、データサイズを削減しています。

特殊コード:
- `"KKK0"` → 手術なし（surgVal=99、全clsのデフォルト）
- `"KKK1"` → 定義テーブルにない手術（surgVal=97）

#### 7）手術・処置等１ → D.p1, D.cn

| Excel列 | 内容 | 変換先 |
|---------|------|--------|
| A列 | MDC | D.p1 キーの先頭2桁 |
| B列 | 分類番号 | D.p1 キーの後半4桁 |
| C列 | 相関値（corrVal） | D.p1[cls] のサブキー |
| F〜I列 | コード名称 + コード（ペアで交互） | D.p1 の配列内容, D.cn |

**相関値（corrVal）**: base-36エンコード（1〜9, A=10, B=11, ...）。値が大きいほど高優先度（「下から優先」ルール）。

#### 8）手術・処置等２ → D.p2, D.cn

構造は手術・処置等1と同様。列位置が若干異なります（E〜H列）。

#### 9）定義副傷病名 → D.sd

| Excel列 | 内容 | 変換先 |
|---------|------|--------|
| A列 | MDC | D.sd キーの先頭2桁 |
| B列 | 分類番号 | D.sd キーの後半4桁 |
| C列 | 相関値 | D.sd[cls] のサブキー |
| F列 | ICD-10コード | D.sd の配列内容 |

#### 10-1〜4）重症度等 → D.sv

4つのシートを統合して生成:

| シート | 内容 | 生成ロジック |
|--------|------|-------------|
| 10-1）ＪＣＳ等 | JCS・年齢のレンジ | `"JCS10以上30未満"` 形式のラベル |
| 10-2）手術等 | 手術による重症度分岐 | ラベル＋値のペア |
| 10-3）重症・軽症 | Burn Index等 | `"Burn Index(0〜9)"` 形式のラベル |
| 10-4）脳卒中の発症時期等 | 発症時期 | 条件名＋ラベル |

各エントリに `name` フィールド（重症度の種類名: "ＪＣＳ", "Burn Index" 等）が付与されます。

#### 11）診断群分類点数表 → D.dpc（日数・点数）, D.lb

| Excel列 | 内容 | 変換先 |
|---------|------|--------|
| B列 | DPCコード14桁 | D.dpc のキー |
| D列 | 手術名称 | D.lb[cls].o[surgVal] |
| E列 | 処置等1名称 | D.lb[cls]["1"][p1Val] |
| F列 | 処置等2名称 | D.lb[cls]["2"][p2Val] |
| G列 | 副傷病名称 | D.lb[cls].s[sdVal] |
| H列 | 重症度等名称 | D.lb[cls].v |
| I列 | 期間Ⅰ日数 | D.dpc[code][7] |
| J列 | 期間Ⅱ日数 | D.dpc[code][8] |
| K列 | 期間Ⅲ日数 | D.dpc[code][9] |
| L列 | 期間Ⅰ点数 | D.dpc[code][10] |
| M列 | 期間Ⅱ点数 | D.dpc[code][11] |
| N列 | 期間Ⅲ点数 | D.dpc[code][12] |

#### 12）変換テーブル → D.dpc（ベース値）, D.br

| Excel列 | 内容 | 変換先 |
|---------|------|--------|
| B列 | DPCコード14桁 | D.dpc のキー |
| C列 | 出来高フラグ | D.dpc[code][2] |
| D列 | MDC | D.dpc[code][0] |
| E列 | 分類番号 | D.dpc[code][1] |
| O列 | 手術区分 | D.dpc[code][3], D.br の分岐判定 |
| P列 | 処置等1相関値 | D.dpc[code][4], D.br の分岐判定 |
| Q列 | 処置等2相関値 | D.dpc[code][5], D.br の分岐判定 |
| R列 | 副傷病相関値 | D.dpc[code][6], D.br の分岐判定 |

**D.br の生成ロジック**: 各cls+surgVal内で、p1Val/p2Val/sdValが2値以上（分岐あり）のときに `{"1":1}`, `{"2":1}`, `{"s":1}` を設定。

#### 13）出来高算定手術等コード → D.dk

| Excel列 | 内容 | 変換先 |
|---------|------|--------|
| B列 | 手術コード | D.dk のキー |
| C列 | 手術名称 | D.dk の値 |

#### D.da（薬剤別名）— Excelに含まれない手動管理データ

D.da は商品名（ブランド名）→処置コードの対応表で、公式Excelには含まれません。
変換スクリプトの `--keep-da` オプションで既存の D.da を保持できます。
新しい薬剤の追加は `src/data.js` 生成後に手動で行ってください。

---

## 4. 更新手順

### Step 1: ソースデータの入手

厚生労働省のWebサイトから **DPC電子点数表（Excel 1ファイル）** を入手します。

**入手先**: 厚生労働省 → 診療報酬 → DPC制度 → 電子点数表

> **注意**: ファイル名は改定ごとに変わります（例: `001660588.xlsx`）。
> 変換スクリプトはファイル名ではなくシート名で自動検出するため、ファイル名を気にする必要はありません。

```bash
# database/ ディレクトリに配置
cp ~/Downloads/XXXXXXXXX.xlsx database/
```

このExcelファイルには以下の18シートが含まれています:

| シート名 | 行数（目安） | 生成されるDキー |
|----------|-------------|----------------|
| 2）分類名称 | ~508 | D.cls |
| 3）病態等分類 | ~6 | D.pt（一部） |
| 4）ＩＣＤ | ~5,900 | D.icd, D.icn |
| 5）年齢、出生時体重等 | ~99 | D.pt（一部） |
| 6）手術 | ~7,031 | D.si, D.sl, D.cn |
| 7）手術・処置等１ | ~2,812 | D.p1, D.cn |
| 8）手術・処置等２ | ~2,720 | D.p2, D.cn |
| 9）定義副傷病名 | ~1,694 | D.sd |
| 10-1）重症度等（ＪＣＳ等） | ~6 | D.sv |
| 10-2）重症度等（手術等） | ~107 | D.sv |
| 10-3）重症度等（重症・軽症） | ~4 | D.sv |
| 10-4）重症度等（脳卒中の発症時期等） | ~23 | D.sv |
| 11）診断群分類点数表 | ~3,252 | D.dpc（日数・点数）, D.lb |
| 12）変換テーブル | ~9,131 | D.dpc（ベース値）, D.br |
| 13）出来高算定手術等コード | ~249 | D.dk |

> **D.da（薬剤別名）について**: D.daは公式Excelに含まれないデータで、手動で管理する必要があります。
> 変換スクリプトの `--keep-da` オプションで既存データを引き継げます。

### Step 2: 変換スクリプトの実行

`scripts/generate-data.mjs` が `database/` 内のExcelを自動検出してデータを生成します。

```bash
# 依存パッケージ（初回のみ）
npm install xlsx

# 基本実行（既存D.daを保持しつつ生成）
node scripts/generate-data.mjs --keep-da

# ドライラン（ファイル出力せず件数のみ確認）
node scripts/generate-data.mjs --dry-run

# ファイルを直接指定する場合
node scripts/generate-data.mjs --file database/新ファイル名.xlsx --keep-da
```

**コマンドオプション:**

| オプション | 説明 |
|-----------|------|
| `--file <path>` | Excelファイルのパスを直接指定（省略時は自動検出） |
| `--out <path>` | 出力先（デフォルト: `src/data.js`） |
| `--keep-da` | 既存 `src/data.js` の D.da（薬剤別名）を保持してマージ |
| `--dry-run` | ファイル出力せず件数サマリーと整合性チェックのみ実行 |

**自動検出の仕組み**: `database/` 内の `.xlsx` ファイルを走査し、「診断群分類点数表」「変換テーブル」「分類名称」「ＩＣＤ」「手術」のシートが全て存在するファイルを自動的に選択します。

### Step 3: 生成結果の確認

スクリプト実行後、以下のような件数サマリーが表示されます:

```
件数サマリー:
  D.dpc :   3248 件
  D.cls :    506 件
  D.lb  :    506 件
  D.br  :    256 件
  D.p1  :    273 件
  D.p2  :    408 件
  D.si  :    506 件
  D.sl  :    594 件
  D.icd :    506 件
  D.icn :   5898 件
  D.sd  :    118 件
  D.sv  :    107 件
  D.dk  :     79 件
  D.cn  :   2323 件
  D.da  :    280 件
  D.pt  :      6 件
  整合性チェック OK
```

スクリプト内蔵の整合性チェック:
- D.dpc の全エントリが配列長13であること
- D.si のインデックスが D.sl の範囲内であること
- 日数が期間I < 期間II < 期間III の順序であること
- 全clsに対応するD.icdエントリが存在すること

### Step 4: 件数の妥当性チェック

生成された件数が前回から大きく逸脱していないか確認します。

**令和6年度の基準値:**

| キー | 件数 | 増減の目安 |
|------|------|-----------|
| D.dpc | 3,248 | ±200程度 |
| D.cls | 506 | ±30程度 |
| D.lb | 506 | clsと同数 |
| D.br | 256 | ±30程度 |
| D.icd | 506 | clsと同数 |
| D.icn | 5,898 | ±500程度 |
| D.cn | 2,323 | ±200程度 |
| D.p1 | 273 | ±50程度 |
| D.p2 | 408 | ±50程度 |
| D.sd | 118 | ±20程度 |
| D.sv | 107 | ±20程度 |
| D.dk | 79 | ±10程度 |
| D.sl | 594 | ±50程度 |
| D.si | 506 | clsと同数 |
| D.da | 280 | 手動管理（自動生成対象外） |
| D.pt | 6 | ±2程度 |

### Step 5: 自動テスト実行

```bash
node _verify.mjs
```

**期待結果:** `ALL TESTS PASSED!` と表示されること。

> **注意**: テストは基本的なデータ整合性を検証しますが、特定のDPCコードをハードコードしている箇所があります（例: `050050`, `DD01`, `J0384`）。改定でこれらのコードが廃止された場合、テスト自体の更新が必要です。

### Step 6: ビルド

```bash
npm run build
```

**期待結果:** `dist/index.html` が生成され、ファイルサイズが 800KB〜1.2MB 程度であること。

### Step 7: 動作確認

```bash
npm run dev
```

ブラウザで以下を確認:

1. **一覧検索モード**: 「肺炎」で検索 → DPC結果が表示される
2. **手術検索**: 「K552」で検索 → 結果表示、ドリルダウン動作
3. **サジェストモード**: 手術コード + 入院日数で検索 → ステップ選択 → DPC候補表示
4. **比較機能**: 2つ以上のDPCを選択 → 比較モーダルでグラフ・テーブル表示
5. **詳細表示**: DPCコードクリック → 詳細モーダルで期間・点数・ICD-10表示

---

## 5. 検証手順

### 5.1 自動テスト

```bash
node _verify.mjs
```

以下の8カテゴリを検証:

| テスト | 内容 |
|--------|------|
| 1. Initial display | 処置コード検索 → 全分岐DPCが展開されるか |
| 2. Drill-down filter | 処置選択時に選択軸のみフィルタされるか |
| 3. Priority filtering | 選択後に低優先度の選択肢が非表示になるか |
| 4. Coding compliance | 特定パターンのコーディングルール準拠 |
| 5. Comprehensive | 全506分類の分岐動作確認 |
| 6. Priority chain | 相関値の大小関係による優先度チェーン |
| 7. cls exclusion | コード非該当の分類が正しく除外されるか |
| 8. Random procedure | 無作為処置コードでの拡張結果整合性 |

### 5.2 手動確認項目

- [ ] DPCコード件数が妥当か（前回比 ±10%以内）
- [ ] 期間Ⅰ < 期間Ⅱ < 期間Ⅲ の日数順序が全DPCで守られているか
- [ ] 点数Ⅰ > 点数Ⅱ > 点数Ⅲ の点数順序が全DPCで守られているか
- [ ] 出来高DPC（dekidaka="0"）の点数が全て0であるか
- [ ] 全clsに対応するD.icdエントリが存在するか
- [ ] D.si の全インデックスが D.sl の範囲内であるか

**日数・点数の整合性チェックスクリプト例:**

```bash
node -e "
  import('./src/data.js').then(({D}) => {
    let err = 0;
    for (const [code, d] of Object.entries(D.dpc)) {
      if (d[2] === '0') {
        // 出来高DPCは点数0であるべき
        if (d[10] || d[11] || d[12]) { err++; console.log('出来高なのに点数あり:', code); }
        continue;
      }
      // 日数順序チェック
      if (d[7] && d[8] && d[7] > d[8]) { err++; console.log('日数逆転 I>II:', code); }
      if (d[8] && d[9] && d[8] > d[9]) { err++; console.log('日数逆転 II>III:', code); }
      // 点数逆順チェック（期間Iが最高であるべき）
      if (d[10] && d[11] && d[10] < d[11]) { err++; console.log('点数逆転 I<II:', code); }
      if (d[11] && d[12] && d[11] < d[12]) { err++; console.log('点数逆転 II<III:', code); }
    }
    console.log(err === 0 ? '整合性チェック OK' : err + '件のエラー');
  });
"
```

---

## 6. デプロイ手順

### GitHub Pages へのデプロイ

```bash
# 1. ビルド
npm run build

# 2. 変更をコミット
git add src/data.js dist/
git commit -m "令和X年度 DPC電子点数表データ更新"

# 3. プッシュ（GitHub Pagesが自動デプロイする場合）
git push origin master
```

**公開URL**: `https://<user>.github.io/DPC_support/`

### ローカル配布

`dist/index.html` は単一ファイルのため、そのままコピーして配布可能です。

---

## 7. トラブルシューティング

### ビルドエラー

| 症状 | 原因 | 対処 |
|------|------|------|
| `SyntaxError in data.js` | JSON形式の不正（カンマ漏れ等） | data.jsをJSON validatorで検証 |
| ビルド成功だが画面真っ白 | D オブジェクトのキーが不足 | 16個のキーが全て存在するか確認 |
| 検索しても結果が出ない | D.dpc の配列構造が不正 | 配列の長さが13であるか確認 |

### テスト失敗

| テスト | よくある原因 | 対処 |
|--------|------------|------|
| test 1-3 失敗 | テスト内のハードコードDPC（050050等）が廃止 | _verify.mjs のテストコードを新しいDPCコードに変更 |
| test 5 失敗 | D.br と D.p1/p2 の不整合 | 分岐ありなのにp1/p2定義がない分類を特定して修正 |
| test 8 失敗 | D.sl のインデックスずれ | D.si の値が D.sl.length 未満であることを確認 |

### UI表示の問題

| 症状 | 原因 | 対処 |
|------|------|------|
| ラベルが「undefined」表示 | D.lb にラベル定義が不足 | 該当clsのD.lbエントリを追加 |
| 手術名が空欄 | D.cn に名称がない | 該当Kコードの名称を追加 |
| ICD病名が空欄 | D.icn に名称がない | 該当ICD-10の病名を追加 |

---

## 8. チェックリスト

データ更新時に以下を順番に確認してください。

### 事前準備

- [ ] 厚生労働省のDPC電子点数表Excelを入手した
- [ ] `database/` ディレクトリにExcelファイルを配置した
- [ ] Node.js v18以上 + `xlsx` パッケージがインストール済み（`npm install xlsx`）
- [ ] 現在の `src/data.js` をバックアップした（`cp src/data.js src/data.js.bak`）

### データ変換

- [ ] `node scripts/generate-data.mjs --dry-run` で件数を事前確認した
- [ ] `node scripts/generate-data.mjs --keep-da` で `src/data.js` を生成した
- [ ] 全16キー（dpc, cls, lb, br, p1, p2, si, sl, icd, icn, sd, sv, dk, cn, da, pt）が存在する
- [ ] 件数が前回比で大きく逸脱していない（±20%以内）
- [ ] 整合性チェックが「OK」と表示された

### 検証

- [ ] `node _verify.mjs` → ALL TESTS PASSED
- [ ] `npx vite build` → ビルド成功
- [ ] `npm run dev` → ブラウザで動作確認（5項目）
- [ ] 日数・点数の整合性チェックスクリプト → エラー0件

### デプロイ

- [ ] git commit + push
- [ ] 公開URLで動作確認
- [ ] 改定年度の表示が正しい（ヘッダーの「令和X年度」）

> **ヘッダー年度表示の変更箇所**: `src/components/DPCTool.jsx` の450行付近
> `令和6年度 DPC電子点数表` → `令和X年度 DPC電子点数表` に変更

---

## 補足: DPC制度の構造的変更があった場合

通常の点数表更新では `src/data.js` のみの変更で済みますが、以下のような制度変更があった場合は `src/utils.js` やUIコンポーネントの改修が必要になります。

| 制度変更の例 | 影響箇所 |
|-------------|---------|
| DPCコードが14桁から変更 | utils.js の全検索ロジック |
| 期間が3段階から4段階に変更 | D.dpc の配列構造、calcTotal、SimChart、CompareChart |
| 新しい分岐軸の追加（処置等3 等） | D.br, utils.js, SuggestRightPanel |
| 重症度スコアの計算方法変更 | D.sv の構造、getSevInfo |

これらの場合は本手順書の範囲を超えるため、開発者による設計・実装が必要です。
